[
  {
    "code": [
      "void ARTPConnection::setMinMaxBitrate(int32_t min, int32_t max) {",
      "    mMinBitrate = min;",
      "    mMaxBitrate = max;",
      "}",
      "void ARTPConnection::showRxBitrate(int64_t nowUs) {",
      "    if (mLastBitrateReportTimeUs <= 0) {",
      "        mCumulativeBytes = 0;",
      "        mLastBitrateReportTimeUs = nowUs;",
      "    }",
      "    else if (mLastBitrateReportTimeUs + 1000000ll <= nowUs) {",
      "        int32_t timeDiff = (nowUs - mLastBitrateReportTimeUs) / 1000000ll;",
      "        ALOGI(\"Actual Rx bitrate : %d bits/sec\", mCumulativeBytes * 8 / timeDiff);",
      "        mCumulativeBytes = 0;",
      "        mLastBitrateReportTimeUs = nowUs;",
      "    }",
      "}",
      "void ARTPConnection::setJbTime(const uint32_t jbTimeMs) {",
      "    mJbTimeMs = jbTimeMs;",
      "}",
      "void ARTPConnection::setTargetBitrate(int32_t targetBitrate) {",
      "    mTargetBitrate = targetBitrate;",
      "}",
      "void ARTPConnection::checkRxBitrate(int64_t nowUs) {",
      "    if (mLastBitrateReportTimeUs <= 0) {",
      "        mCumulativeBytes = 0;",
      "        mLastBitrateReportTimeUs = nowUs;",
      "    }",
      "    else if (mLastBitrateReportTimeUs + 1000000ll <= nowUs) {",
      "        int32_t timeDiff = (nowUs - mLastBitrateReportTimeUs) / 1000000ll;",
      "        int32_t bitrate = mCumulativeBytes * 8 / timeDiff;",
      "        ALOGI(\"Actual Rx bitrate : %d bits/sec\", bitrate);",
      "",
      "        sp<ABuffer> buffer = new ABuffer(kMaxUDPSize);",
      "        List<StreamInfo>::iterator it = mStreams.begin();",
      "        while (it != mStreams.end()) {",
      "            StreamInfo *s = &*it;",
      "            if (s->mIsInjected) {",
      "                ++it;",
      "                continue;",
      "            }",
      "",
      "            if (s->mNumRTCPPacketsReceived == 0) {",
      "                // We have never received any RTCP packets on this stream,",
      "                // we don't even know where to send a report.",
      "                ++it;",
      "                continue;",
      "            }",
      "",
      "            buffer->setRange(0, 0);",
      "",
      "            for (size_t i = 0; i < s->mSources.size(); ++i) {",
      "                sp<ARTPSource> source = s->mSources.valueAt(i);",
      "                source->notifyPktInfo(bitrate, nowUs);",
      "                source->addTMMBR(buffer, mTargetBitrate);",
      "            }",
      "            if (buffer->size() > 0) {",
      "                ALOGV(\"Sending TMMBR...\");",
      "",
      "                ssize_t n = send(s, buffer);",
      "",
      "                if (n <= 0) {",
      "                    ALOGW(\"failed to send RTCP TMMBR (%s).\",",
      "                         n == 0 ? \"connection gone\" : strerror(errno));",
      "",
      "                    it = mStreams.erase(it);",
      "                    continue;",
      "                }",
      "",
      "                CHECK_EQ(n, (ssize_t)buffer->size());",
      "            }",
      "            ++it;",
      "        }",
      "        mCumulativeBytes = 0;",
      "        mLastBitrateReportTimeUs = nowUs;",
      "    }",
      "}"
    ],
    "label": "",
    "index": 3,
    "confidence": 0.4,
    "desc": "List merge."
  }
]